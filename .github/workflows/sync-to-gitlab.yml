name: Sync to GitLab

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Allow force push on protected branch
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          curl -s --request PATCH \
            --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            --data "allow_force_push=true" \
            "https://gitlab.com/api/v4/projects/78190812/protected_branches/main"
      
      - name: Push branches and tags to GitLab
        run: |
          git remote add gitlab https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/baby_tracker/baby_tracker.git
          git push gitlab --all --force
          git push gitlab --tags --force

  create-mr:
    if: github.event_name == 'pull_request'
    needs: sync
    runs-on: ubuntu-latest
    steps:
      - name: Create Merge Request on GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          SOURCE_BRANCH: ${{ github.head_ref }}
          TARGET_BRANCH: ${{ github.base_ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Creating MR: $PR_TITLE ($SOURCE_BRANCH -> $TARGET_BRANCH)"
          
          response=$(curl -s -w "\n%{http_code}" --request POST \
            --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$(jq -n \
              --arg source "$SOURCE_BRANCH" \
              --arg target "$TARGET_BRANCH" \
              --arg title "$PR_TITLE" \
              '{source_branch: $source, target_branch: $target, title: $title}')" \
            "https://gitlab.com/api/v4/projects/78190812/merge_requests")
          
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "201" ]; then
            echo "✅ Merge Request created successfully"
            echo "$body" | jq -r '.web_url'
          elif [ "$http_code" = "409" ]; then
            echo "⚠️ Merge Request already exists (skipping)"
          else
            echo "❌ Failed to create Merge Request (HTTP $http_code)"
            echo "$body"
            exit 1
          fi
