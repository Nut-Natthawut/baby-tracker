name: Sync to GitLab

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, closed]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Allow force push on protected branch
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          response=$(curl -s -w "\n%{http_code}" --request PATCH \
            --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            --data "allow_force_push=true" \
            "https://gitlab.com/api/v4/projects/78190812/protected_branches/main")
          
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          echo "Response (HTTP $http_code):"
          echo "$body" | jq . 2>/dev/null || echo "$body"
          
          if [ "$http_code" != "200" ]; then
            echo "⚠️ Warning: Failed to update protected branch settings (HTTP $http_code)"
          else
            echo "✅ Force push enabled on main branch"
          fi
          
          sleep 2

      - name: Push branches and tags to GitLab
        run: |
          git remote add gitlab https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/baby_tracker/baby_tracker.git
          git fetch gitlab
          git push gitlab --all --force
          git push gitlab --tags --force

  create-mr:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Create Merge Request on GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          SOURCE_BRANCH: ${{ github.head_ref }}
          TARGET_BRANCH: ${{ github.base_ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "Creating MR: $PR_TITLE ($SOURCE_BRANCH -> $TARGET_BRANCH)"
          
          response=$(curl -s -w "\n%{http_code}" --request POST \
            --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "$(jq -n \
              --arg source "$SOURCE_BRANCH" \
              --arg target "$TARGET_BRANCH" \
              --arg title "$PR_TITLE" \
              '{source_branch: $source, target_branch: $target, title: $title}')" \
            "https://gitlab.com/api/v4/projects/78190812/merge_requests")
          
          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" = "201" ]; then
            echo "✅ Merge Request created successfully"
            echo "$body" | jq -r '.web_url'
          elif [ "$http_code" = "409" ]; then
            echo "⚠️ Merge Request already exists (skipping)"
          else
            echo "❌ Failed to create Merge Request (HTTP $http_code)"
            echo "$body"
            exit 1
          fi

  merge-mr:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Merge corresponding MR on GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          SOURCE_BRANCH: ${{ github.head_ref }}
        run: |
          echo "Finding MR for branch: $SOURCE_BRANCH"
          
          # Find open MR by source branch
          mr_iid=$(curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "https://gitlab.com/api/v4/projects/78190812/merge_requests?source_branch=${SOURCE_BRANCH}&state=opened" \
            | jq '.[0].iid')
          
          if [ "$mr_iid" != "null" ] && [ -n "$mr_iid" ]; then
            echo "Found MR !${mr_iid}, merging..."
            
            # Accept/merge the MR
            result=$(curl -s -w "\n%{http_code}" --request PUT \
              --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              "https://gitlab.com/api/v4/projects/78190812/merge_requests/${mr_iid}/merge?should_remove_source_branch=true")
            
            http_code=$(echo "$result" | tail -1)
            
            if [ "$http_code" = "200" ]; then
              echo "✅ MR !${mr_iid} merged successfully on GitLab"
            else
              echo "⚠️ Could not auto-merge MR !${mr_iid} (HTTP $http_code)"
              echo "Closing MR instead..."
              curl -s --request PUT \
                --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
                --header "Content-Type: application/json" \
                --data '{"state_event": "close"}' \
                "https://gitlab.com/api/v4/projects/78190812/merge_requests/${mr_iid}"
              echo "✅ MR !${mr_iid} closed"
            fi
          else
            echo "⚠️ No open MR found for branch $SOURCE_BRANCH"
          fi
